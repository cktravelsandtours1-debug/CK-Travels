<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Flights | Admin | CK Travels</title>

    <link rel="stylesheet" href="css/main.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                    }
                }
            }
        }
    </script>
    <style>
        .admin-sidebar {
            background: #fdfdfd;
            border-right: 1px solid #eee;
            height: calc(100vh - 72px);
            padding: 24px 0;
        }

        .admin-nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            color: #444;
            text-decoration: none;
            font-weight: 500;
        }

        .admin-nav-item:hover,
        .admin-nav-item.active {
            background: #f0f0f0;
            color: var(--color-primary);
        }

        .admin-content {
            padding: 32px;
            background: #fbfbfb;
            min-height: calc(100vh - 72px);
        }

        /* Reverting generic table styles to avoid conflict with Tailwind */
    </style>
</head>

<body>
    <nav class="navbar bg-white border-b border-gray-200 px-6 py-3 flex justify-between items-center">
        <a href="index.html" class="logo font-bold text-xl text-gray-800">CK Travels <span
                class="text-xs text-primary font-bold border border-primary px-1 rounded ml-1 align-middle">ADMIN</span></a>

        <div class="flex gap-3 items-center">
            <span id="admin-name" class="font-semibold text-sm">Admin</span>
            <a href="#" onclick="handleLogout(event)" class="text-sm text-gray-600 hover:text-gray-900">Logout</a>
        </div>
    </nav>

    <div class="grid grid-cols-[240px_1fr]">
        <aside class="admin-sidebar hidden md:block">
            <a href="admin-dashboard.html" class="admin-nav-item"><span>üìä</span> Overview</a>
            <a href="admin-bookings.html" class="admin-nav-item"><span>üé´</span> Bookings</a>
            <a href="admin-flights.html" class="admin-nav-item active"><span>‚úàÔ∏è</span> Manage Flights</a>
            <a href="admin-packages.html" class="admin-nav-item"><span>üó∫Ô∏è</span> Manage Packages</a>
        </aside>

        <main class="admin-content">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-2xl font-bold">Manage Flights</h1>
                <div class="flex gap-2">
                    <button class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded text-sm"
                        onclick="testConnection()">Test Connection</button>
                    <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-sm"
                        onclick="showAddModal()">+ Add New Flight</button>
                </div>
            </div>

            <div id="loading-indicator" class="text-center p-5 text-gray-500">
                Connecting to Firebase...
            </div>

            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="w-full text-left border-collapse" id="flights-table" style="display: none;">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600 text-xs uppercase border-b border-gray-200">
                            <th class="p-4">Airline</th>
                            <th class="p-4">Flight #</th>
                            <th class="p-4">Route</th>
                            <th class="p-4">Time</th>
                            <th class="p-4">Stops</th>
                            <th class="p-4">Price</th>
                            <th class="p-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="flights-table-body" class="text-sm">
                        <!-- Rows will be populated by JS -->
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Add/Edit Modal (Expanded for more details) -->
    <div id="add-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center overflow-auto py-10">
        <div class="bg-white rounded-xl shadow-2xl w-[600px] max-w-[95%] max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white z-10">
                <h2 id="modal-title" class="text-xl font-bold">Add New Flight</h2>
                <button onclick="hideAddModal()" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>

            <form id="add-flight-form" class="p-6 space-y-6">
                <input type="hidden" id="edit-id">

                <!-- Section 1: Basic Info -->
                <div class="space-y-4">
                    <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider">Flight Information</h3>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Airline</label>
                            <input type="text" id="airline"
                                class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none"
                                placeholder="e.g. Emirates" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Flight Number</label>
                            <input type="text" id="flightNumber"
                                class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none"
                                placeholder="e.g. EK202" required>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">From (City Code)</label>
                            <input type="text" id="from"
                                class="w-full border border-gray-300 rounded px-3 py-2 text-sm uppercase"
                                placeholder="DXB" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">To (City Code)</label>
                            <input type="text" id="to"
                                class="w-full border border-gray-300 rounded px-3 py-2 text-sm uppercase"
                                placeholder="LHR" required>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Departure Time</label>
                            <input type="time" id="departureTime"
                                class="w-full border border-gray-300 rounded px-3 py-2 text-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Arrival Time</label>
                            <input type="time" id="arrivalTime"
                                class="w-full border border-gray-300 rounded px-3 py-2 text-sm" required>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Details & Pricing -->
                <div class="space-y-4 pt-4 border-t border-gray-100">
                    <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider">Details & Pricing</h3>

                    <div class="grid grid-cols-3 gap-4">
                        <div class="col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Price ($)</label>
                            <input type="number" id="price"
                                class="w-full border border-gray-300 rounded px-3 py-2 text-sm font-bold"
                                placeholder="500" required>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Stops</label>
                            <select id="stops" class="w-full border border-gray-300 rounded px-3 py-2 text-sm bg-white">
                                <option value="Non-stop">Non-stop</option>
                                <option value="1 Stop">1 Stop</option>
                                <option value="2+ Stops">2+ Stops</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Aircraft Type</label>
                            <input type="text" id="aircraft"
                                class="w-full border border-gray-300 rounded px-3 py-2 text-sm" placeholder="Boeing 777"
                                value="Boeing 777">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Total Duration</label>
                            <input type="text" id="duration"
                                class="w-full border border-gray-300 rounded px-3 py-2 text-sm" placeholder="7h 30m"
                                required>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Amenities & Baggage -->
                <div class="space-y-4 pt-4 border-t border-gray-100">
                    <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider">Amenities & Policy</h3>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Cabin Baggage (kg)</label>
                            <input type="number" id="baggageCabin"
                                class="w-full border border-gray-300 rounded px-3 py-2 text-sm" value="7">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Checked Baggage (kg)</label>
                            <input type="number" id="baggageChecked"
                                class="w-full border border-gray-300 rounded px-3 py-2 text-sm" value="23">
                        </div>
                    </div>

                    <div class="flex flex-col gap-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="isRefundable" class="w-4 h-4 text-blue-600 rounded">
                            <span class="text-sm text-gray-700">Refundable Ticket</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="hasWifi" class="w-4 h-4 text-blue-600 rounded" checked>
                            <span class="text-sm text-gray-700">In-flight Wi-Fi Available</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="hasMeal" class="w-4 h-4 text-blue-600 rounded" checked>
                            <span class="text-sm text-gray-700">Meal Included</span>
                        </label>
                    </div>
                </div>

                <div class="flex gap-3 pt-4 border-t border-gray-100 sticky bottom-0 bg-white pb-6">
                    <button type="button"
                        class="flex-1 py-3 border border-gray-300 rounded text-gray-600 hover:bg-gray-50 font-medium transition-colors"
                        onclick="hideAddModal()">Cancel</button>
                    <button type="submit" id="submit-btn"
                        class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium shadow-lg transition-all transform active:scale-95">Save
                        Flight</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK v8.10.0 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBsrtZh0PBOjNA8c8-9sifdtVqKMk7q-fs",
            authDomain: "ck-travels-8926e.firebaseapp.com",
            projectId: "ck-travels-8926e",
            storageBucket: "ck-travels-8926e.firebasestorage.app",
            messagingSenderId: "310809428136",
            appId: "1:310809428136:web:74e2b0216f58088cf3829d",
            measurementId: "G-HNT07JXC3C"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        db.settings({ experimentalForceLongPolling: true });

        let flights = [];

        function checkAuth() {
            try {
                const user = JSON.parse(localStorage.getItem('ck_travels_user') || 'null');
                if (!user) window.location.href = 'admin-login.html';
            } catch (e) {
                window.location.href = 'admin-login.html';
            }
        }

        function logout() {
            localStorage.removeItem('ck_travels_user');
            window.location.href = 'index.html';
        }

        function renderTable() {
            const tbody = document.getElementById('flights-table-body');
            tbody.innerHTML = '';

            flights.forEach((flight) => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-100 hover:bg-gray-50 transition-colors";
                tr.innerHTML = `
                    <td class="p-4 font-medium text-gray-900">${flight.airline}</td>
                    <td class="p-4"><code class="bg-gray-100 px-2 py-1 rounded text-xs text-gray-600">${flight.flightNumber}</code></td>
                    <td class="p-4 text-gray-600 font-medium">${flight.from} <span class="text-gray-400 mx-1">‚Üí</span> ${flight.to}</td>
                    <td class="p-4 text-gray-500">${flight.departure}</td>
                    <td class="p-4"><span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${flight.stops === 'Non-stop' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${flight.stops}</span></td>
                    <td class="p-4 font-bold text-gray-900">$${flight.price}</td>
                    <td class="p-4 text-right">
                        <button class="text-blue-600 hover:text-blue-800 p-2" title="Edit" onclick="editFlight('${flight.id}')">‚úèÔ∏è</button>
                        <button class="text-red-500 hover:text-red-700 p-2" title="Delete" onclick="deleteFlight('${flight.id}')">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('loading-indicator').style.display = 'none';
            document.getElementById('flights-table').style.display = 'table';

            if (flights.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-8 text-gray-500">No flights found. Click "Add New Flight" to create one.</td></tr>';
            }
        }

        // --- GLOBAL ACTIONS ---
        window.fetchFlights = function () {
            console.log("Fetching flights from Firebase...");
            document.getElementById('loading-indicator').textContent = "Fetching data from cloud...";

            db.collection("flights").get()
                .then((querySnapshot) => {
                    console.log("Successfully fetched " + querySnapshot.size + " flights.");
                    flights = [];
                    querySnapshot.forEach((doc) => {
                        flights.push({ id: doc.id, ...doc.data() });
                    });
                    renderTable();
                })
                .catch((error) => {
                    console.error("Error getting documents: ", error);
                    document.getElementById('loading-indicator').textContent = "Error loading data: " + error.message;
                    alert("Network Error: " + error.message);
                });
        }

        window.testConnection = function () {
            alert("Testing connection to Firebase...");
            db.collection("flights").limit(1).get()
                .then(() => alert("Connection Successful!"))
                .catch(e => alert("Connection Failed: " + e.message));
        }

        window.showAddModal = function (isEdit = false) {
            const modal = document.getElementById('add-modal');
            const title = document.getElementById('modal-title');
            const btn = document.getElementById('submit-btn');

            if (!isEdit) {
                document.getElementById('add-flight-form').reset();
                document.getElementById('edit-id').value = '';
                title.textContent = "Add New Flight";
                btn.textContent = "Save Flight";
                btn.disabled = false;
            } else {
                title.textContent = "Edit Flight";
                btn.textContent = "Update Flight";
                btn.disabled = false;
            }
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        window.hideAddModal = function () {
            const modal = document.getElementById('add-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };

        window.editFlight = function (id) {
            const flight = flights.find(f => f.id === id);
            if (!flight) return;

            document.getElementById('edit-id').value = id;
            document.getElementById('airline').value = flight.airline;
            document.getElementById('flightNumber').value = flight.flightNumber || '';
            document.getElementById('from').value = flight.from;
            document.getElementById('to').value = flight.to;
            document.getElementById('price').value = flight.price;
            document.getElementById('departureTime').value = flight.departure;
            document.getElementById('arrivalTime').value = flight.arrival;
            document.getElementById('stops').value = flight.stops || 'Non-stop';
            document.getElementById('duration').value = flight.duration || '';
            document.getElementById('aircraft').value = flight.aircraft || '';
            document.getElementById('baggageCabin').value = flight.baggage?.cabin || 7;
            document.getElementById('baggageChecked').value = flight.baggage?.checked || 23;
            document.getElementById('isRefundable').checked = flight.isRefundable || false;
            document.getElementById('hasWifi').checked = flight.hasWifi !== false;
            document.getElementById('hasMeal').checked = flight.hasMeal !== false;

            showAddModal(true);
        };

        window.deleteFlight = function (id) {
            if (confirm('Are you sure you want to delete this flight?')) {
                db.collection("flights").doc(id).delete()
                    .then(() => {
                        fetchFlights();
                    })
                    .catch(e => alert("Error deleting: " + e.message));
            }
        };

        window.handleLogout = function (e) { if (e) e.preventDefault(); logout(); };

        document.getElementById('add-flight-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const btn = document.getElementById('submit-btn');
            const originalText = btn.textContent;
            btn.textContent = "Saving...";
            btn.disabled = true;

            const editId = document.getElementById('edit-id').value;

            const flightData = {
                airline: document.getElementById('airline').value,
                flightNumber: document.getElementById('flightNumber').value,
                from: document.getElementById('from').value.toUpperCase(),
                to: document.getElementById('to').value.toUpperCase(),
                price: parseFloat(document.getElementById('price').value),
                departure: document.getElementById('departureTime').value,
                arrival: document.getElementById('arrivalTime').value,
                stops: document.getElementById('stops').value,
                duration: document.getElementById('duration').value,
                aircraft: document.getElementById('aircraft').value,
                baggage: {
                    cabin: parseInt(document.getElementById('baggageCabin').value),
                    checked: parseInt(document.getElementById('baggageChecked').value)
                },
                isRefundable: document.getElementById('isRefundable').checked,
                hasWifi: document.getElementById('hasWifi').checked,
                hasMeal: document.getElementById('hasMeal').checked,
                class: 'Economy' // Default for now
            };

            const action = editId ?
                db.collection("flights").doc(editId).update(flightData) :
                db.collection("flights").add(flightData);

            const timeout = new Promise((_, reject) =>
                setTimeout(() => reject(new Error("Request timed out.")), 20000)
            );

            Promise.race([action, timeout])
                .then(() => {
                    alert("Flight Saved Successfully!");
                    fetchFlights();
                    hideAddModal();
                    btn.textContent = originalText;
                    btn.disabled = false;
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("Error saving: " + error.message);
                    btn.textContent = originalText;
                    btn.disabled = false;
                });
        });

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            fetchFlights();
        });
    </script>
</body>

</html>